---
title: "Untitled"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r}
## read tables from sbtab file and convert to a list
read_sbtab <- function(file, na = ""){
  # read in file and create empty list and name vector
  sbtab <- read_lines(file, lazy = FALSE)
  sbtab <- append(sbtab, " ") # every table needs an empty line below it
  tables <- list()
  name <- vector()
  c = 1 # counter for list item
  for(i in sbtab){
    # detect column name line
    if(str_detect(i, "^\\!(?!\\!)")){
      # set table name and create table with column names
      name <- append(name, table_names[which(table_names == str_extract(sbtab[which(i == sbtab)-1], table_names))])
      tables <- append(tables, list(str_split(i, "\t")))
      names(tables) <- name
      tables[[c]] <- as_tibble(tables[[c]], .name_repair = "minimal") %>% t() %>% as_tibble(.name_repair = "minimal")
      names(tables[[c]]) <- tables[[c]][1,] %>% as.character()
      # get table content and write to table
      tab_content <- sbtab[(which(i==sbtab)+1):(which(" "==sbtab)[c]-1)]
      for(l in tab_content){
        vector <- tables[[c]][1,] %>% unlist
        vector[1:length(vector)] <- unlist(strsplit(l, "\t"))
        vector <- vector %>% t() %>% as_tibble()
        tables[[c]][which(l == tab_content),] <- vector
      }
      # remove "!" from column names
      names(tables[[c]]) <- str_remove_all(names(tables[[c]]), "!")
      c = c+1
      closeAllConnections()
    } 
  }
  return(tables)
}

file <- "celldesigner_exampleV1.tsv"
i <- sbtab[3]
l <- tab_content[1]

cell_tabs <- read_sbtab("celldesigner_exampleV1.tsv")
filename <- "testfile"

sbml_file <- c('<?xml version="1.0" encoding="UTF-8"?>', # First two lines are base formatting for xml and do not change
               '<sbml xmlns="http://www.sbml.org/sbml/level2/version4" xmlns:celldesigner="http://www.sbml.org/2001/ns/celldesigner" level="2" version="4">', 
               paste0('<model metaid="', filename, '" id="', filename, '">'), #'filename' is defined by the documentname
               '<annotation>',
               '<celldesigner:extension>',
               '<celldesigner:modelVersion>4.0</celldesigner:modelVersion>', #Celldesigner model version will always be 4 in this converter
               '<celldesigner:modelDisplay sizeX="3000" sizeY="3000"/>', #Size of the Celldesigner map(may be changeable in the future)
               
               
)

write_lines(sbml_file, file = "test.xml")
```

